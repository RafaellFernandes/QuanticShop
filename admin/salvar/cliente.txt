<?php
  //verificar se não está logado
  if ( !isset ( $_SESSION["quanticshop"]["id"] ) ){
    exit;
  }
      //mostrar erros
    ini_set('display_errors',1);
    ini_set('display_startup_erros',1);
    error_reporting(E_ALL);

  //verificar se existem dados no POST
  if ( $_POST ) {
    include "../admin/validacao/functions.php";
    include "../admin/config/conexao.php";

  	//recuperar os dados do formulario
    $id = $primeiro_nome = $sobrenome = $cpf  = $data_nascimento = $email = $senha = $cep = $telefone = $celular = $foto = $sexo = 
    $pessoaFJ = $nomeFantasia = $razaoSocial = $cnpj = $inscricao_estadual =  $estado = $cidade = $endereco = $bairro = 
    $complemento = $numero_resid = $cidade_id = $ativo = "";
      
      //print_r($_POST);
      //print_r($_FILES);
      
  	foreach ($_POST as $key => $value) {
  	//guardar as variaveis
    $$key = trim ( $value );
  		
    }

    if( empty($primeiro_nome) ){
        echo "<script>alert('Digite seu Primeiro Nome!');history.back();</script>";
    } else if( empty($sobrenome) ){
      echo "<script>alert('Digite seu Sobrenome!');history.back();</script>";
    } else if( empty($cpf) ){
        echo "<script>alert('Digite seu CPF!');history.back();</script>";
    } else if( empty($data_nascimento) ){
        echo "<script>alert('Digite sua data de Nascimento!');history.back();</script>";
    } else if( empty($cep) ){
        echo "<script>alert('Digite seu Cep!');history.back();</script>";
    } else if( empty($email) ){
        echo "<script>alert('Preencha o Email!');history.back();</script>";
    } else if( empty($endereco) ){
        echo "<script>alert('Preencha o Endereço!');history.back();</script>";
    } else if( empty($celular) ){
        echo "<script>alert('Preencha o Celular!');history.back();</script>";
    } else if( empty($senha) ){
        echo "<script>alert('Preencha a Senha!');history.back();</script>";
    } else if( empty($numero_resid) ){
      echo "<script>alert('Digite o Numero da Residencia!');history.back();</script>";
  }

    //iniciar uma transacao
    $pdo->beginTransaction();
    
    $data_nascimento = formatar($data_nascimento);
    
    $arquivo = time()."-".$_SESSION["quanticshop"]["id"];
         
      if(empty($id)){
          
          //$Senha = password_hash($Senha, PASSWORD_DEFAULT);
          $senha = password_hash($senha, PASSWORD_BCRYPT);
          //inserir se o id estiver em branco
          $sql = "INSERT INTO cliente (primeiro_nome, sobrenome, cpf, data_nascimento, email, senha, cep, endereco, complemento, bairro, cidade_id, foto, telefone, celular, numero_resid, pessoaFJ, sexo, cidade, estado, nomeFantasia, razaoSocial, cnpj, inscricao_estadual, ativo) 
          VALUES (:primeiro_nome, :sobrenome, :cpf, :data_nascimento, :email, :senha, :cep, :endereco, :complemento, :bairro, :cidade_id, :foto, :telefone, :celular, :numero_resid, :pessoaFJ, :sexo, :cidade, :estado, :nomeFantasia, :razaoSocial, :cnpj, :inscricao_estadual, :ativo) ";
          $consulta = $pdo->prepare($sql);
          $consulta->bindParam(":primeiro_nome", $primeiro_nome);
          $consulta->bindParam(":sobrenome", $sobrenome);
          $consulta->bindParam(":cpf", $cpf);
          $consulta->bindParam(":data_nascimento", $data_nascimento);
          $consulta->bindParam(":email", $email);
          $consulta->bindParam(":senha", $senha);
          $consulta->bindParam(":cep", $cep);
          $consulta->bindParam(":endereco", $endereco);
          $consulta->bindParam(":complemento", $complemento);
          $consulta->bindParam(":bairro", $bairro);
          $consulta->bindParam(":cidade_id", $cidade_id);
          $consulta->bindParam(":foto", $arquivo);
          $consulta->bindParam(":telefone", $telefone);
          $consulta->bindParam(":celular", $celular);
          $consulta->bindParam(":numero_resid", $numero_resid);
          $consulta->bindParam(":pessoaFJ", $pessoaFJ);
          $consulta->bindParam(":sexo", $sexo);
          $consulta->bindParam(":cidade", $cidade);
          $consulta->bindParam(":estado", $estado);
          $consulta->bindParam(":nomeFantasia", $nomeFantasia);
          $consulta->bindParam(":razaoSocial", $razaoSocial);
          $consulta->bindParam(":cnpj", $cnpj);
          $consulta->bindParam(":inscricao_estadual", $inscricao_estadual);
          $consulta->bindParam(":ativo", $ativo);
        
          
          
      } else {
          //update se o id estiver preenchido
          //qual arquivo sera gravado
            if(!empty( $_FILES["foto"]["name"])){
                $foto = $arquivo;
            }
                    
          $sql = "UPDATE cliente SET primeiro_nome = :primeiro_nome, sobrenome = :sobrenome, cpf = :cpf, data_nascimento = :data_nascimento,
           email = :email, senha = :senha, cep = :cep, endereco = :endereco, complemento = :complemento,
         bairro = :bairro, cidade_id = :cidade_id, foto = :foto, telefone = :telefone, celular = :celular, 
            numero_resid = :numero_resid, pessoaFJ = :pessoaFJ, sexo = :sexo, cidade = :cidade, estado = :estado, nomeFantasia = :nomeFantasia,
            razaoSocial = :razaoSocial, cnpj = :cnpj, inscricao_estadual = :inscricao_estadual, ativo = :ativo WHERE id = :id";
          $consulta = $pdo->prepare($sql);
          $consulta->bindParam(":primeiro_nome", $primeiro_nome);
          $consulta->bindParam(":sobrenome", $sobrenome);
          $consulta->bindParam(":cpf", $cpf);
          $consulta->bindParam(":data_nascimento", $data_nascimento);
          $consulta->bindParam(":email", $email);
          $consulta->bindParam(":senha", $senha);
          $consulta->bindParam(":cep", $cep);
          $consulta->bindParam(":endereco", $endereco);
          $consulta->bindParam(":complemento", $complemento);
          $consulta->bindParam(":bairro", $bairro);
          $consulta->bindParam(":cidade_id", $cidade_id);
          $consulta->bindParam(":foto", $arquivo);
          $consulta->bindParam(":telefone", $telefone);
          $consulta->bindParam(":celular", $celular);
          $consulta->bindParam(":numero_resid", $numero_resid);
          $consulta->bindParam(":pessoaFJ", $pessoaFJ);
          $consulta->bindParam(":sexo", $sexo);
          $consulta->bindParam(":cidade", $cidade);
          $consulta->bindParam(":estado", $estado);
          $consulta->bindParam(":nomeFantasia", $nomeFantasia);
          $consulta->bindParam(":razaoSocial", $razaoSocial);
          $consulta->bindParam(":cnpj", $cnpj);
          $consulta->bindParam(":inscricao_estadual", $inscricao_estadual);
          $consulta->bindParam(":ativo", $ativo);
          $consulta->bindParam(":id", $id);
          
      }
      //executar e verificar se deu certo
        if ( $consulta->execute() ) {
                //verificar se o arquivo nao está sendo enviado 
            if( empty($_FILES["foto"]["type"]) and (!empty($id)) ){
                //a capa deve estar vazia e ID nao estiver vazio
                //gravar no banco 
                $pdo->commit();
                echo "<script>alert('Cliente Salvo com Sucesso!');location.href='listar/cliente';</script>";

            }
            //veririfcar tipo imagem
            if($_FILES["foto"]["type"]  !=  "image/jpeg"){
                echo "<script>alert('Seleciona uma imagem Jpeg');history.back();</script>";
                exit;
            }
            if ( move_uploaded_file($_FILES["foto"]["tmp_name"], "../fotos/".$_FILES["foto"]["name"])){

                $pastaFotos = "../fotos/";
                $nome = $arquivo;
                $imagem = $_FILES["foto"]["name"];
                redimensionarImagem($pastaFotos,$imagem,$nome);

                //gravar no banco - se tudo deu certo
                $pdo->commit();
                echo "<script>alert('Cliente Salvo com Sucesso!');location.href='listar/cliente';</script>";
            }

            //erro ao gravar
            echo "<script>alert('Erro ao gravar no servidor');history.back();</script>";
            exit;
        } else {
            echo '<script>alert("Erro ao salvar");history.back();</script>';
            exit;
        }
  }