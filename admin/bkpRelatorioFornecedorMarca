<?php
session_start();

require_once __DIR__ . '/vendor/autoload.php';
$mpdf = new \Mpdf\Mpdf();


function abrirBanco(){
    $conexao = new mysqli("localhost", "root", "", "quanticshop");
    return $conexao;
}

function selectAllPessoa(){
    $banco = abrirBanco();
    $sql = "SELECT ic.id icid, ic.status icstatus, ic.*,
                m.id mid, m.*, 
                f.id fid, f.*, 
                p.id pid, p.ativo pativo, p.*  
            FROM item_compra ic
            INNER JOIN produto p ON (p.id = ic.produto_id)
            INNER JOIN fornecedor f ON (f.id = ic.fornecedor_id)
            INNER JOIN marca m ON (m.id = p.marca_id)
            WHERE ic.status = 1
            ORDER BY p.vezesVendido DESC";

    $resultado = $banco->query($sql);
    $banco->close();
    while ($row = mysqli_fetch_array($resultado)) {
        $grupo[] = $row;
    }
    return $grupo;
}

$grupo = selectAllPessoa();

// $mpdf->SetDisplayMode("fullpage");

$stylesheet = file_get_contents('stylepdf.css');
date_default_timezone_set('America/Sao_Paulo');

$nome = $_SESSION['quanticshop']['primeiro_nome'];
// $nome =  $_SERVER['HTTP_USER_AGENT'];

$html = "
<h2>Relatório de Marca Mais Comprada por Fornecedor</h2>
<p>Data de Emissão: ". date('d/m/Y H:i:s')."</p>
<p>Gerado Por: ". $nome ."</p><hr/>
    <div>
        <table>
            <thead>
                <tr>
                <th>ID MARCA <br> NOME MARCA</th>
                <th>ID FORNECEDOR <br> RAZAO SOCIAL</th>
                <th>CNPJ</th>
                <th>EMAIL<br>SITE</th>
                <th>TELEFONE<br>CELULAR</th>
                <th>CIDADE-UF</th>
                </tr>
            </thead>
            <tbody>";
                    foreach ($grupo as $pessoa) {
                
                    $html = $html ."    <tr>
                        <td>{$pessoa["mid"]}<br>{$pessoa["nome_marca"]}</td>
                        <td>{$pessoa["fid"]}<br>{$pessoa["razaoSocial"]}</td>
                        <td>".($pessoa["cnpj"])."</td>
                        <td>{$pessoa["email"]}<br>{$pessoa["siteFornecedor"]}</td>
                        <td>{$pessoa["telefone"]}<br>{$pessoa["celular"]}</td>
                        <td>{$pessoa["cidade_id"]}<br>{$pessoa["cidade"]}-{$pessoa["estado"]}</td>
                        
                     </tr>";
                 }
               
          $html = $html ."  </tbody>
        </table></div>";


$mpdf->WriteHTML($stylesheet,\Mpdf\HTMLParserMode::HEADER_CSS);
$mpdf->WriteHTML($html,\Mpdf\HTMLParserMode::HTML_BODY);
$mpdf->Output();